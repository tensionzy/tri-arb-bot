# 三角套利机器人设计

---

## 一、目的

使用100美元的初始资金，在低费用的Binance Smart Chain (BSC)上，选择流动性较好的交易对，通过频繁的小额套利积累收益。选择BSC上的主要去中心化交易所PancakeSwap进行交易。

## 二、模块设计

### 2.1 市场数据收集模块

* **交易对的选择**

  * 利用The Graph来查询PancakeSwap子图流动池信息。

  * 获取这些交易对的详细数据，交易对id、价格、交易额、流动性等。

  * 基于这些数据，选择TVL高、交易量大、流动性好、波动适中的交易对。

    ```json
    {
      pools(
        first: 40
        orderBy: totalValueLockedUSD
        orderDirection: desc
        where: {
         	liquidity_gt: "10000", 
          totalValueLockedUSD_gt: "10000", 
          volumeUSD_gt: "1000"}
      ) {
        id	#流动池的唯一标识符
        token0 {
          id	#代币的唯一标识符
          symbol	#代币的符号
        }
        token1 {
          id
          symbol
        }
        volumeUSD	#累计交易量
      	totalValueLockedUSD	#总锁定价值
        createdAtTimestamp
    		liquidity	#流动池当前流动性
        tick	#流动池的当前价格刻度
    		feeTier #费用
      }
    }
    ```

* **交易路径规划（例如：BUSD -> USDT -> BNB -> BUSD）**
  
  * 首先，我选择了一个常见的基础资产——**USDT**，因为它是稳定币，通常具有较大的交易量和流动性。
  
  * 接下来，我从返回的结果中寻找与**USDT**相关的交易对，并确认这些交易对是否满足以下条件：
  
    * **高 TVL**：表明该交易对中锁定的资产较多，流动性较好。
    * **大交易量**：表明该交易对市场活跃度高。
    * **低滑点**：流动性好的交易对通常滑点较低，适合套利。
  
  * 构建三角套利路径
  
    在找到合适的交易对后，我根据逻辑将它们链接起来，形成一个从**USDT**出发，经过其他资产，最终回到 USDT 的路径。具体步骤如下：
  
    1. **USDT -> WBNB**:
  
       **交易对**: `USDT-WBNB`
  
       **交易对 ID**: `0x36696169c63e42cd08ce11f5deebbcebae652050`
  
       **理由**: USDT 是一个常用的起始资产，而 WBNB 是 BSC 网络上的核心资产之一。这个交易对的 TVL 和交易量都很高，流动性好，适合作为路径的起点。
  
    2. **WBNB -> ETH**:
  
       **交易对**: `WBNB-ETH`
  
       **交易对 ID**: `0x4bba1018b967e59220b22ca03f68821a3276c9a6`
  
       **理由**: ETH 是另一个主流资产，并且在 BSC 网络上有较高的流动性。将 WBNB 转换为 ETH 可以保持路径的流动性和市场深度。
  
    3. **ETH -> USDT**:
  
       **交易对**: `ETH-USDT`
  
       **交易对 ID**: `0x7f51c8aaa6b0599abd16674e2b17fec7a9f674a1`
  
       **理由**: 最后一步是将 ETH 转换回 USDT，完成整个套利路径。这个交易对的 TVL 也4较高，且交易量适中，确保交易顺利完成。
  
  在确认了每一步的交易对和资产后，我确保路径中的每个交易对都有足够的流动性和市场活跃度，以支持多次交易而不会引起显著的价格滑点。通过循环交易，理论上可以利用市场中的价格差异获利。
  
* **价格数据实时获取**

  * 确定了交易对，通过Infura连接到BSC节点。
  * 通过调用智能合约方法，实时获取交易对的价格、流动性，从而计算出滑点等数据。
  * 利用这些实时价格数据，监控市场并等待合适的套利机会.一旦确定套利机会，立即执行三笔交易，完成套利流程。

### 2.2 交易执行模块

* **自动化交易**：使用Web3与PancakeSwap智能合约交互，发送交易请求。
* **交易监控**：监控交易执行情况，处理交易失败或网络延迟等问题。
* **收益结算**：计算每次套利后的净收益，并将结果存储到数据库中。

### 2.3 风险管理模块

* **止损设置**：设定一个最低收益阈值，若预计收益低于该值则放弃交易。
* **资金保护**：设置一个最高交易次数或资金利用率的上限，以防止连续亏损。
* **报警系统**：如果出现异常情况（如多次交易失败或资金异常），发送报警通知到预设的邮箱或即时通讯工具（如Telegram）。

### 2.4 报告与优化模块
